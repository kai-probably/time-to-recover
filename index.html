import { cssVar } from "./utils.js";

const zoneAndGradientPlugin = {
  id: "zoneAndGradient",
  beforeDraw(chart, args, options) {
    const { ctx, chartArea, scales } = chart;
    if (!chartArea) return;

    // Debug: subtle outline to confirm the plugin is running (remove later if desired)
    ctx.save();
    ctx.strokeStyle = cssVar("--border") || "rgba(0,0,0,0.15)";
    ctx.lineWidth = 1;
    ctx.strokeRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
    ctx.restore();

    const pluginOptions = chart.options.plugins.zoneAndGradient || {};
    const ready = pluginOptions?.readyThreshold;
    const full = pluginOptions?.fullThreshold;
    const dangerColor = pluginOptions?.dangerColor || "rgba(216,29,58,0.10)";
    const positiveColor = pluginOptions?.positiveColor || "rgba(29,104,216,0.06)";

    if (ready === undefined || full === undefined) return;

    const yAxis = scales.y;
    const top = chartArea.top;
    const bottom = chartArea.bottom;
    const left = chartArea.left;
    const right = chartArea.right;

    const readyY = yAxis.getPixelForValue(ready);
    const fullY = yAxis.getPixelForValue(full);

    ctx.save();

    // Danger zone (above full threshold)
    ctx.fillStyle = dangerColor;
    ctx.fillRect(left, top, right - left, fullY - top);

    // Positive zone (between ready and full)
    ctx.fillStyle = positiveColor;
    ctx.fillRect(left, fullY, right - left, readyY - fullY);

    ctx.restore();
  },
};

const ctx = document.getElementById("recoveryChart").getContext("2d");

const recoveryChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      {
        label: "Recovery",
        data: [],
        borderColor: cssVar("--accent"),
        backgroundColor: cssVar("--accent"),
        fill: false,
        tension: 0.3,
      },
    ],
  },
  options: {
    responsive: true,
    animation: false,
    scales: {
      x: {
        type: "linear",
        position: "bottom",
        min: 0,
        max: 72,
        ticks: {
          stepSize: 12,
          callback: (val) => `${val}h`,
        },
      },
      y: {
        min: 0,
        max: 1,
        ticks: {
          callback: (val) => `${Math.round(val * 100)}%`,
        },
      },
    },
    plugins: {
      legend: {
        display: false,
      },
      tooltip: {
        enabled: false,
      },
      zoneAndGradient: {
        readyThreshold: 0.75,
        fullThreshold: 0.90,
        dangerColor: "rgba(216,29,58,0.10)",
        positiveColor: "rgba(29,104,216,0.06)"
      },
    },
  },
  plugins: [zoneAndGradientPlugin],
});

export default recoveryChart;